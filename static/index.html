<!DOCTYPE html>
<html>
<head><title>YT Viewer</title></head>
<body>
  <h2>You are a Viewer</h2>
  <div id="player"></div>

  <script>
    let tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.body.appendChild(tag);

    let player, ws;
    let currentVideoId = "dQw4w9WgXcQ";
    let playlistId = null;

    function connectWS() {
      const protocol = location.protocol === "https:" ? "wss://" : "ws://";
      ws = new WebSocket(protocol + location.host + "/ws");

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === "sync") {
          const s = data.state;
          currentVideoId = s.videoId;
          playlistId = s.playlistId || null;

          if (player) {
            if (playlistId) {
              player.loadPlaylist({ list: playlistId });
            } else {
              player.loadVideoById(currentVideoId);
            }
            player.seekTo(s.currentTime + (Date.now()/1000 - s.timestamp));
            if (!s.playing) player.pauseVideo();
          }
        }
      };
    }

    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '390', width: '640',
        videoId: currentVideoId,
        playerVars: {
          controls: 0,
          disablekb: 1,
          modestbranding: 1,
        },
        events: {
          onReady: connectWS
        }
      });
    }
  </script>
</body>
</html>
