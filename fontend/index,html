<!DOCTYPE html>
<html>
<head>
  <title>YouTube Sync Viewer</title>
  <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>
  <input type="text" id="ytLink" placeholder="Paste YouTube Link" />
  <button onclick="changeVideo()">Change</button>
  <button onclick="playVideo()">‚ñ∂Ô∏è Play</button>
  <button onclick="pauseVideo()">‚è∏Ô∏è Pause</button>
  <button onclick="restart()">üîÅ Restart</button>

  <div id="player"></div>

  <script>
    const isHost = new URLSearchParams(window.location.search).get("host") === "true";
    let player;
    let state = {
      videoId: "dQw4w9WgXcQ",
      playing: false,
      currentTime: 0,
      timestamp: Date.now()
    };

    let ws;
    if (location.protocol === "https:") {
      ws = new WebSocket("wss://yt-sync-backend.onrender.com");
    } else {
      ws = new WebSocket("ws://" + location.hostname + ":8765");
    }

    ws.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      if (msg.type === "sync") {
        state = msg.state;
        syncPlayer();
      }
    };

    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '405',
        width: '720',
        videoId: state.videoId,
        events: {
          'onReady': () => syncPlayer()
        }
      });

      if (!isHost) {
        document.getElementById("ytLink").style.display = "none";
        Array.from(document.querySelectorAll("button")).forEach(btn => {
          if (btn.textContent !== "Change") btn.style.display = "none";
        });
      }
    }

    function syncPlayer() {
      const delay = (Date.now() - state.timestamp * 1000) / 1000;
      const targetTime = state.currentTime + delay;

      if (state.videoId !== player.getVideoData().video_id) {
        player.loadVideoById({ videoId: state.videoId, startSeconds: targetTime });
      } else {
        player.seekTo(targetTime, true);
        state.playing ? player.playVideo() : player.pauseVideo();
      }
    }

    function sendUpdate() {
      if (!isHost) return;
      const newState = {
        videoId: state.videoId,
        playing: state.playing,
        currentTime: player.getCurrentTime(),
        timestamp: Date.now() / 1000
      };
      ws.send(JSON.stringify({ type: "update", state: newState }));
    }

    function extractVideoID(url) {
      const match = url.match(/[?&]v=([a-zA-Z0-9_-]{11})/) || url.match(/youtu\.be\/([a-zA-Z0-9_-]{11})/);
      return match ? match[1] : null;
    }

    function changeVideo() {
      if (!isHost) return;
      const input = document.getElementById("ytLink").value.trim();
      const vid = extractVideoID(input);
      if (!vid) return alert("Invalid YouTube link!");
      state.videoId = vid;
      state.playing = true;
      state.currentTime = 0;
      sendUpdate();
    }

    function playVideo() {
      if (!isHost) return;
      state.playing = true;
      sendUpdate();
    }

    function pauseVideo() {
      if (!isHost) return;
      state.playing = false;
      sendUpdate();
    }

    function restart() {
      if (!isHost) return;
      state.currentTime = 0;
      state.playing = false;
      sendUpdate();
    }
  </script>
</body>
</html>
